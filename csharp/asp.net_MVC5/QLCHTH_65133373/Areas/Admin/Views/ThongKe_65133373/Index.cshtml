@model QLCHTH_65133373.Models.ViewModels.ThongKeViewModel
@{
    ViewBag.Title = "Thống kê doanh thu";
}

<h1 class="mt-4">
    <i class="fas fa-chart-bar me-2"></i>Thống kê doanh thu
</h1>
<ol class="breadcrumb mb-4">
    <li class="breadcrumb-item"><a href="@Url.Action("Index", "Dashboard_65133373")">Dashboard</a></li>
    <li class="breadcrumb-item active">Thống kê</li>
</ol>

<div class="card mb-4">
    <div class="card-header"><i class="fas fa-filter me-1"></i>Bộ lọc thống kê</div>
    <div class="card-body">
        <form method="get" class="row g-3">
            <div class="col-md-3">
                <label class="form-label">Loại thống kê</label>
                <select name="loaiThongKe" class="form-select" id="loaiThongKe">
                    <option value="ngay" @(ViewBag.LoaiThongKe == "ngay" ? "selected" : "")>Theo ngày</option>
                    <option value="thang" @(ViewBag.LoaiThongKe == "thang" ? "selected" : "")>Theo tháng</option>
                    <option value="nam" @(ViewBag.LoaiThongKe == "nam" ? "selected" : "")>Theo năm</option>
                    <option value="khoang" @(ViewBag.LoaiThongKe == "khoang" ? "selected" : "")>Khoảng thời gian</option>
                </select>
            </div>
            <div class="col-md-2" id="divNgay">
                <label class="form-label">Ngày</label>
                <input type="date" name="ngay" class="form-control" value="@(ViewBag.Ngay ?? DateTime.Now.ToString("yyyy-MM-dd"))" />
            </div>
            <div class="col-md-2" id="divThang" style="display:none;">
                <label class="form-label">Tháng</label>
                <select name="thang" class="form-select">
                    @for (int i = 1; i <= 12; i++)
                    {
                        <option value="@i" @(ViewBag.Thang == i ? "selected" : "")>Tháng @i</option>
                    }
                </select>
            </div>
            <div class="col-md-2" id="divNam">
                <label class="form-label">Năm</label>
                <select name="nam" class="form-select">
                    @for (int y = DateTime.Now.Year; y >= DateTime.Now.Year - 5; y--)
                    {
                        <option value="@y" @(ViewBag.Nam == y ? "selected" : "")>@y</option>
                    }
                </select>
            </div>
            <div class="col-md-2" id="divTuNgay" style="display:none;">
                <label class="form-label">Từ ngày</label>
                <input type="date" name="tuNgay" class="form-control" value="@ViewBag.TuNgay" />
            </div>
            <div class="col-md-2" id="divDenNgay" style="display:none;">
                <label class="form-label">Đến ngày</label>
                <input type="date" name="denNgay" class="form-control" value="@ViewBag.DenNgay" />
            </div>
            <div class="col-md-2 d-flex align-items-end">
                <button type="submit" class="btn btn-primary w-100"><i class="fas fa-chart-line me-1"></i>Thống kê</button>
            </div>
        </form>
    </div>
</div>

<div class="row">
    <div class="col-xl-3 col-md-6">
        <div class="card bg-primary text-white mb-4">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <div class="small">Tổng doanh thu</div>
                        <div class="fs-4 fw-bold">@Model.TongDoanhThu.ToString("N0") đ</div>
                    </div>
                    <i class="fas fa-dollar-sign fa-2x opacity-50"></i>
                </div>
            </div>
        </div>
    </div>
    <div class="col-xl-3 col-md-6">
        <div class="card bg-success text-white mb-4">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <div class="small">Số hóa đơn</div>
                        <div class="fs-4 fw-bold">@Model.SoHoaDon</div>
                    </div>
                    <i class="fas fa-file-invoice fa-2x opacity-50"></i>
                </div>
            </div>
        </div>
    </div>
    <div class="col-xl-3 col-md-6">
        <div class="card bg-warning text-white mb-4">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <div class="small">Số sản phẩm bán</div>
                        <div class="fs-4 fw-bold">@Model.SoSanPhamBan</div>
                    </div>
                    <i class="fas fa-boxes fa-2x opacity-50"></i>
                </div>
            </div>
        </div>
    </div>
    <div class="col-xl-3 col-md-6">
        <div class="card bg-danger text-white mb-4">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <div class="small">Tổng giảm giá</div>
                        <div class="fs-4 fw-bold">@Model.TongGiamGia.ToString("N0") đ</div>
                    </div>
                    <i class="fas fa-tags fa-2x opacity-50"></i>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-8">
        <div class="card mb-4">
            <div class="card-header"><i class="fas fa-trophy me-1"></i>Top 10 sản phẩm bán chạy</div>
            <div class="card-body">
                @if (Model.TopSanPhamBanChay.Any())
                {
                    <div class="table-responsive">
                        <table class="table table-bordered table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th style="width: 50px;">#</th>
                                    <th>Sản phẩm</th>
                                    <th class="text-center" style="width: 100px;">SL bán</th>
                                    <th class="text-end" style="width: 150px;">Doanh thu</th>
                                </tr>
                            </thead>
                            <tbody>
                                @{ int stt = 0; }
                                @foreach (var sp in Model.TopSanPhamBanChay)
                                {
                                    stt++;
                                    <tr>
                                        <td class="text-center">
                                            @if (stt == 1)
                                            {
                                                <span class="badge bg-warning text-dark"><i class="fas fa-medal"></i> 1</span>
                                            }
                                            else if (stt == 2)
                                            {
                                                <span class="badge bg-secondary"><i class="fas fa-medal"></i> 2</span>
                                            }
                                            else if (stt == 3)
                                            {
                                                <span class="badge bg-danger"><i class="fas fa-medal"></i> 3</span>
                                            }
                                            else
                                            {
                                                @stt
                                            }
                                        </td>
                                        <td>@sp.TenSanPham</td>
                                        <td class="text-center"><span class="badge bg-info">@sp.SoLuongBan</span></td>
                                        <td class="text-end fw-bold">@sp.DoanhThu.ToString("N0") đ</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                }
                else
                {
                    <div class="text-center py-4 text-muted">
                        <i class="fas fa-chart-bar fa-2x mb-2"></i>
                        <p>Không có dữ liệu trong khoảng thời gian này</p>
                    </div>
                }
            </div>
        </div>
    </div>
    
    <div class="col-md-4">
        <div class="card mb-4">
            <div class="card-header"><i class="fas fa-folder me-1"></i>Doanh thu theo danh mục</div>
            <div class="card-body">
                @if (Model.DoanhThuTheoDanhMuc.Any())
                {
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead class="table-light">
                                <tr>
                                    <th>Danh mục</th>
                                    <th class="text-end">Doanh thu</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var dm in Model.DoanhThuTheoDanhMuc)
                                {
                                    <tr>
                                        <td>@dm.TenDanhMuc</td>
                                        <td class="text-end">@dm.DoanhThu.ToString("N0") đ</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                }
                else
                {
                    <div class="text-center py-4 text-muted">
                        <i class="fas fa-folder-open fa-2x mb-2"></i>
                        <p>Không có dữ liệu</p>
                    </div>
                }
            </div>
        </div>
    </div>
</div>

@section scripts {
    <script>
        function updateFilterVisibility() {
            var loai = document.getElementById('loaiThongKe').value;
            document.getElementById('divNgay').style.display = (loai === 'ngay') ? '' : 'none';
            document.getElementById('divThang').style.display = (loai === 'thang') ? '' : 'none';
            document.getElementById('divNam').style.display = (loai === 'ngay' || loai === 'khoang') ? 'none' : '';
            document.getElementById('divTuNgay').style.display = (loai === 'khoang') ? '' : 'none';
            document.getElementById('divDenNgay').style.display = (loai === 'khoang') ? '' : 'none';
        }
        
        document.getElementById('loaiThongKe').addEventListener('change', updateFilterVisibility);
        updateFilterVisibility();
    </script>
}
